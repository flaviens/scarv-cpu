
XCFI_SRC_DIR    = $(FRV_HOME)/verif/rvfi
XCFI_WORK       = $(FRV_WORK)/xcfi

XCFI_COMMON     = $(XCFI_SRC_DIR)/fi_fairness.sv \
                  $(XCFI_SRC_DIR)/xcfi_insn_checker.sv \
                  $(XCFI_SRC_DIR)/xcfi_macros.sv \
                  $(XCFI_SRC_DIR)/xcfi_testbench.v \
                  $(XCFI_SRC_DIR)/xcfi_wrapper.sv \
                  $(XCRYPTO_RTL)/xc_sha3/xc_sha3_ftb.v \
                  $(XCRYPTO_RTL)/xc_sha256/xc_sha256_ftb.v \
                  $(XCRYPTO_RTL)/xc_aessub/xc_aessub_ftb.v \
                  $(XCRYPTO_RTL)/xc_aesmix/xc_aesmix_ftb.v


XCFI_MODELS     = $(notdir $(basename $(shell find $(XCFI_SRC_DIR)/models -name '*.v')))

XCFI_SBY_TGTS   = $(addsuffix _bmc.sby,$(addprefix $(XCFI_WORK)/,$(XCFI_MODELS))) \
                  $(addsuffix _cov.sby,$(addprefix $(XCFI_WORK)/,$(XCFI_MODELS)))

XCFI_SBY_LOGS   = $(addsuffix _bmc/logfile.txt,$(addprefix $(XCFI_WORK)/,$(XCFI_MODELS))) \
                  $(addsuffix _cov/logfile.txt,$(addprefix $(XCFI_WORK)/,$(XCFI_MODELS)))


XCFI_SBY_BMC_SRC= $(FRV_HOME)/flow/xcfi-formal/bmc.sby.template
XCFI_SBY_COV_SRC= $(FRV_HOME)/flow/xcfi-formal/cov.sby.template

$(XCFI_WORK)/%_bmc.sby : $(XCFI_SRC_DIR)/models/%.v $(XCFI_COMMON)
	@mkdir -p $(dir $@)
	@cp $(XCFI_SBY_BMC_SRC) $@
	@echo "read_verilog -sv $^" >> $@
	@echo "read_verilog -DRVFI -sv $(CPU_RTL_SRCS)" >> $@
	@echo "prep -flatten -nordff -top xcfi_testbench" >> $@
	@echo "chformal -early" >> $@

$(XCFI_WORK)/%_cov.sby : $(XCFI_SRC_DIR)/models/%.v $(XCFI_COMMON)
	@mkdir -p $(dir $@)
	@cp $(XCFI_SBY_COV_SRC) $@
	@echo "read_verilog -sv $^" >> $@
	@echo "read_verilog -DRVFI -sv $(CPU_RTL_SRCS)" >> $@
	@echo "prep -flatten -nordff -top xcfi_testbench" >> $@
	@echo "chformal -early" >> $@

$(XCFI_WORK)/%_bmc/logfile.txt : $(XCFI_WORK)/%_cov/logfile.txt
$(XCFI_WORK)/%_bmc/logfile.txt : $(XCFI_WORK)/%_bmc.sby
	sby -f $<

$(XCFI_WORK)/%_cov/logfile.txt : $(XCFI_WORK)/%_cov.sby
	sby -f $<

xcfi-prepare: $(XCFI_SBY_TGTS)

xcfi-clean:
	rm -rf $(XCFI_WORK)/*

xcfi-run: $(XCFI_SBY_LOGS)
	
