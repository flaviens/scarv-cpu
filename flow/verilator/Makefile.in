
VERILATOR = $(VERILATOR_ROOT)/bin/verilator

#
# 1. Top module name
define map_vl_mdir
$(SCARV_CPU)/work/verilator/$(strip ${1})
endef

#
# 1. Top module name
define map_vl_exe
$(call map_vl_mdir,${1})/verilated-$(strip ${1})
endef

#
# 1. Top module name
define map_vl_makefile
$(call map_vl_mdir,${1})/V$(strip ${1}).mk
endef

#
# 1. Top Module Name
# 2. target command file
# 3. Extra verilator flags
define add_vl_target

.PHONY: $(call map_vl_exe,${1})
$(call map_vl_exe,${1}) : ${2}
	mkdir -p $(call map_vl_mdir,${1})
	$(VERILATOR) \
        -f ${2} \
        -o $(call map_vl_exe,${1}) \
        -GSME_SMAX="4'd$(SME_SMAX)" \
        --Mdir $(call map_vl_mdir,${1}) \
        --top-module ${1} ${3}
	$(MAKE) -j$(nproc) -C $(call map_vl_mdir,${1}) -f $(call map_vl_makefile,${1})

build-${1}: $(call map_vl_exe,${1})

endef

#
# Core level testbench
# ------------------------------------------------------------

CMD_CORE = $(SCARV_CPU)/flow/verilator/cmd-core-tb.txt
TOP_CORE = frv_core
EXE_CORE = $(call map_vl_exe,$(TOP_CORE))
FLG_CORE =

$(eval $(call add_vl_target,$(TOP_CORE),$(CMD_CORE),$(FLG_CORE)))

#
# CCX level tesbench
# ------------------------------------------------------------

CMD_CCX  = $(SCARV_CPU)/flow/verilator/cmd-ccx-tb.txt
TOP_CCX  = scarv_ccx_top_v
EXE_CCX  = $(call map_vl_exe,$(TOP_CCX))
FLG_CCX  =

$(eval $(call add_vl_target,$(TOP_CCX),$(CMD_CCX),$(FLG_CCX)))


#
# SME SBOX Middle Layer level tesbench
# ------------------------------------------------------------

CMD_SME_MID  = $(SCARV_CPU)/flow/verilator/manifest-sme-sbox-mid.txt
TOP_SME_MID  = tb_sme_sboxes_sbox_inv_mid 
EXE_SME_MID  = $(call map_vl_exe,$(TOP_SME_MID))
FLG_SME_MID  =

$(eval $(call add_vl_target,$(TOP_SME_MID),$(CMD_SME_MID),$(FLG_SME_MID)))

#
# SME AES SBOX tesbench
# ------------------------------------------------------------

CMD_SME_AES  = $(SCARV_CPU)/flow/verilator/manifest-sme-aes-sbox.txt
TOP_SME_AES  = tb_sme_aes_sbox
EXE_SME_AES  = $(call map_vl_exe,$(TOP_SME_AES))
FLG_SME_AES  =

$(eval $(call add_vl_target,$(TOP_SME_AES),$(CMD_SME_AES),$(FLG_SME_AES)))

