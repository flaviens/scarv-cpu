
VERILATOR = $(VERILATOR_ROOT)/bin/verilator

#
# 1. Top module name
define map_vl_mdir
$(SCARV_CPU)/work/verilator/$(strip ${1})
endef

#
# 1. Top module name
define map_vl_exe
$(call map_vl_mdir,${1})/verilated-$(strip ${1})
endef

#
# 1. Top module name
define map_vl_makefile
$(call map_vl_mdir,${1})/V$(strip ${1}).mk
endef

#
# 1. Top Module Name
# 2. target command file
# 3. Extra verilator flags
define add_vl_target

.PHONY: $(call map_vl_exe,${1})
$(call map_vl_exe,${1}) : ${2}
	mkdir -p $(call map_vl_mdir,${1})
	$(VERILATOR) \
        -f ${2} \
        -o $(call map_vl_exe,${1}) \
        --Mdir $(call map_vl_mdir,${1}) \
        --top-module ${1} ${3}
	$(MAKE) -C $(call map_vl_mdir,${1}) -f $(call map_vl_makefile,${1})

build-${1}: $(call map_vl_exe,${1})

endef

#
# Core level testbench
# ------------------------------------------------------------

CMD_CORE = $(SCARV_CPU)/flow/verilator/cmd-core-tb.txt
TOP_CORE = frv_core
EXE_CORE = $(call map_vl_exe,$(TOP_CORE))
FLG_CORE =

$(eval $(call add_vl_target,$(TOP_CORE),$(CMD_CORE),$(FLG_CORE)))

